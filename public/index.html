<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZaHouse Forensic Alpha</title>
    <style>
        :root { --gold: #D4AF37; --black: #1a1a1a; --dark-gray: #2d2d2d; }
        body { background-color: var(--black); color: white; font-family: 'Courier New', Courier, monospace; margin: 0; display: flex; height: 100vh; }
        
        /* SIDEBAR */
        .sidebar { width: 300px; background: var(--dark-gray); padding: 20px; border-right: 2px solid var(--gold); display: flex; flex-direction: column; justify-content: space-between; }
        .logo { font-size: 24px; font-weight: bold; color: var(--gold); margin-bottom: 40px; text-transform: uppercase; letter-spacing: 2px; }
        .stats { font-size: 12px; color: #888; line-height: 1.6; }
        
        /* CHAT AREA */
        .main { flex: 1; display: flex; flex-direction: column; padding: 20px; }
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; border: 1px solid #333; margin-bottom: 20px; border-radius: 5px; background: #000; }
        .message { margin-bottom: 15px; padding: 10px; border-radius: 5px; max-width: 80%; }
        .user { background: #333; align-self: flex-end; margin-left: auto; border: 1px solid #555; }
        .ai { background: #111; border-left: 3px solid var(--gold); white-space: pre-wrap; }
        
        /* INPUT AREA */
        .input-area { display: flex; gap: 10px; padding: 10px; background: var(--dark-gray); border-radius: 5px; }
        input[type="text"] { flex: 1; background: transparent; border: none; color: white; font-family: inherit; outline: none; }
        button { background: var(--gold); color: black; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        button:hover { opacity: 0.9; }
        
        /* MODAL (EMAIL GATE) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--black); border: 2px solid var(--gold); padding: 30px; width: 400px; text-align: center; }
        .modal h2 { color: var(--gold); margin-top: 0; }
        .email-input { width: 90%; padding: 10px; margin: 20px 0; background: #333; border: 1px solid #555; color: white; }
        
        /* DOWNLOAD BUTTON */
        .download-btn { background: transparent; border: 1px solid var(--gold); color: var(--gold); margin-top: 10px; display: none; width: 100%; }
        .download-btn:hover { background: var(--gold); color: black; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div>
            <div class="logo">ZH | ZaHouse</div>
            <div class="stats">
                <p>‚öñÔ∏è FORENSIC ALPHA ACTIVE</p>
                <p>üß† BRAIN: LLAMA-3.3</p>
                <p>üåç EYES: TAVILY V3</p>
            </div>
        </div>
        <div id="status">Protocol: Ready</div>
    </div>

    <div class="main">
        <div class="chat-box" id="chatBox">
            <div class="message ai">Protocol Initiated. I am the ZaHouse Strategist. Upload a contract to begin the Forensic Audit, or ask me about Copyright traps.</div>
        </div>
        
        <div class="input-area">
            <input type="file" id="fileInput" style="display: none;">
            <button onclick="document.getElementById('fileInput').click()">üìé PDF</button>
            <input type="text" id="userInput" placeholder="Ask a question or upload a deal..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">SEND</button>
        </div>
    </div>

    <div id="emailModal" class="modal">
        <div class="modal-content">
            <h2>üîí PROTOCOL LOCKED</h2>
            <p>Forensic Alpha reports are restricted to members.</p>
            <p>Enter your email to unlock this audit.</p>
            <input type="email" id="emailField" class="email-input" placeholder="artist@example.com">
            <button onclick="submitEmail()">UNLOCK REPORT</button>
        </div>
    </div>

    <script>
        let storedFile = null;
        let userEmail = null;
        let lastAuditData = null; // Stores score/verdict for PDF generation

        // Handle File Selection
        document.getElementById('fileInput').addEventListener('change', (e) => {
            storedFile = e.target.files[0];
            document.getElementById('userInput').value = `[Attached: ${storedFile.name}]`;
            sendMessage();
        });

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const chatBox = document.getElementById('chatBox');
            const message = input.value;
            if (!message && !storedFile) return;

            // 1. User Message to Screen
            chatBox.innerHTML += `<div class="message user">${message}</div>`;
            input.value = '';
            
            // 2. Prepare Data
            const formData = new FormData();
            formData.append('message', message);
            if (storedFile) formData.append('file', storedFile);
            if (userEmail) formData.append('email', userEmail);

            chatBox.innerHTML += `<div class="message ai" id="loading">Running Forensic Analysis...</div>`;
            const loadingMsg = document.getElementById('loading');

            try {
                // 3. Send to Server
                const res = await fetch('/audit', { method: 'POST', body: formData });
                const data = await res.json();
                loadingMsg.remove();

                // 4. CHECK: Does it require email? (The Revenue Gate)
                if (data.requiresEmail) {
                    document.getElementById('emailModal').style.display = 'flex';
                    chatBox.innerHTML += `<div class="message ai">üîí **ACCESS DENIED:** Please enter email to proceed.</div>`;
                    return; // Stop here, wait for modal
                }

                // 5. Success - Show Response
                chatBox.innerHTML += `<div class="message ai">${marked(data.response)}</div>`;
                
                // 6. PARSER: Check if we got a Scorecard
                if (data.response.includes("DEAL SCORE:")) {
                    parseAndShowDownload(data.response);
                    storedFile = null; // Reset file
                }

            } catch (err) {
                loadingMsg.innerText = "Error: " + err.message;
            }
        }

        async function submitEmail() {
            const email = document.getElementById('emailField').value;
            if (!email.includes('@')) return alert("Enter a valid email.");
            
            // Save email and retry the upload
            userEmail = email;
            document.getElementById('emailModal').style.display = 'none';
            
            // Register lead then re-send the message
            await fetch('/capture-lead', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email }) 
            });
            
            // Re-trigger the last message (which failed)
            sendMessage(); 
        }

        function parseAndShowDownload(text) {
            // Simple Logic to extract data for the PDF
            // We look for the Score and Verdict in the markdown text
            const scoreMatch = text.match(/DEAL SCORE:.*?(\d+)\/100/);
            const score = scoreMatch ? scoreMatch[1] : "N/A";
            
            // Save this data for the download button
            lastAuditData = {
                score: score,
                verdict: text.substring(0, 500), // Grab first 500 chars as verdict summary
                riskTable: [
                   ['Masters', 'Check Text', 'Review'],
                   ['Royalties', 'Check Text', 'Review'],
                   ['360 Clause', 'Check Text', 'Review']
                ]
            };

            // Add Download Button to Chat
            const btnId = 'dl-' + Date.now();
            const btnHtml = `<button id="${btnId}" class="download-btn" onclick="downloadPDF()">üìÑ DOWNLOAD OFFICIAL AUDIT REPORT (PDF)</button>`;
            document.getElementById('chatBox').insertAdjacentHTML('beforeend', btnHtml);
            document.getElementById(btnId).style.display = 'block';
        }

        async function downloadPDF() {
            if (!lastAuditData) return;
            const btn = document.querySelector('.download-btn');
            btn.innerText = "‚è≥ GENERATING PDF...";
            
            const res = await fetch('/download-audit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(lastAuditData)
            });

            if (res.ok) {
                // Convert response to Blob and force download
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "ZaHouse_Forensic_Audit.pdf";
                document.body.appendChild(a);
                a.click();
                a.remove();
                btn.innerText = "‚úÖ DOWNLOAD COMPLETE";
            }
        }
        
        // Simple Markdown parser for bold text
        function marked(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/\n/g, '<br>')
                .replace(/# (.*?)/g, '<h2>$1</h2>');
        }
    </script>
</body>
</html>
