<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ZaHouse | Forensic Alpha</title>
    <style>
        :root { --bg: #050505; --gold: #D4AF37; --white: #fff; --gray: #1a1a1a; }
        body { background: var(--bg); color: var(--white); font-family: sans-serif; display: flex; height: 100vh; margin: 0; overflow: hidden; }
        .sidebar { width: 300px; background: #0a0a0a; border-right: 1px solid #222; padding: 40px; }
        .main { flex: 1; display: flex; flex-direction: column; }
        .chat { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .msg { padding: 20px; border-radius: 12px; max-width: 80%; line-height: 1.6; }
        .ai { background: #111; border-left: 3px solid var(--gold); }
        .user { background: #333; align-self: flex-end; }
        .input-bar { padding: 30px; background: #000; display: flex; gap: 10px; }
        input { flex: 1; background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 15px; border-radius: 8px; outline: none; }
        button { background: var(--gold); border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: #111; border: 1px solid var(--gold); padding: 40px; width: 400px; text-align: center; }
        .dl-btn { background: transparent; border: 1px solid var(--gold); color: var(--gold); width: 100%; margin-top: 15px; padding: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2 style="color:var(--gold)">ZH ZaHouse</h2>
        <p style="font-size:12px; color:#888;">STRATEGIST PROTOCOL V5.6</p>
    </div>
    <div class="main">
        <div class="chat" id="chatBox">
            <div class="msg ai">Yo, I'm the <strong>ZaHouse Music Law Strategist.</strong> Drop a contract or ask me about splits. I'm here to ensure you own the dirt, not just the bricks.</div>
        </div>
        <div class="input-bar">
            <input type="file" id="fileInput" style="display:none" onchange="handleFile()">
            <button onclick="document.getElementById('fileInput').click()">ðŸ“Ž</button>
            <input type="text" id="userInput" placeholder="Upload contract..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">âž”</button>
        </div>
    </div>
    <div id="emailModal" class="modal">
        <div class="modal-box">
            <h2 style="color:var(--gold)">ðŸ”’ PROTOCOL LOCKED</h2>
            <p>Forensic Alpha reports are reserved for Protocol Members.</p>
            <input type="email" id="emailField" placeholder="artist@example.com" style="width:90%; padding:10px; margin-bottom:20px;">
            <button onclick="submitEmail()" style="width:100%">UNLOCK REPORT</button>
        </div>
    </div>
    <script>
        let storedFile = null, userEmail = null, lastScore = 0, lastVerdict = "";
        function handleFile() { storedFile = document.getElementById('fileInput').files[0]; document.getElementById('userInput').value = `Attached: ${storedFile.name}`; }
        async function sendMessage() {
            const input = document.getElementById('userInput'), chat = document.getElementById('chatBox');
            if (!input.value && !storedFile) return;
            chat.innerHTML += `<div class="msg user">${input.value}</div>`;
            const formData = new FormData(); formData.append('message', input.value);
            if (storedFile) formData.append('file', storedFile);
            if (userEmail) formData.append('email', userEmail);
            input.value = ''; chat.scrollTop = chat.scrollHeight;
            const res = await fetch('/audit', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.requiresEmail) { document.getElementById('emailModal').style.display='flex'; return; }
            chat.innerHTML += `<div class="msg ai">${data.response.replace(/\n/g, '<br>')}</div>`;
            
            // ðŸ”¥ SMART BUTTON LOGIC: ONLY SHOW IF IT'S A GENUINE AUDIT
            if (data.isAudit && data.response.includes("DEAL SCORE:")) {
                const match = data.response.match(/DEAL SCORE:.*?(\d+)\/100/);
                lastScore = match ? match[1] : 0; 
                lastVerdict = data.response;
                chat.innerHTML += `<button class="dl-btn" onclick="downloadPDF()">ðŸ“„ DOWNLOAD OFFICIAL AUDIT PDF</button>`;
            }
            chat.scrollTop = chat.scrollHeight; storedFile = null;
        }
        async function submitEmail() {
            userEmail = document.getElementById('emailField').value;
            if (!userEmail.includes('@')) return alert("Invalid email");
            document.getElementById('emailModal').style.display='none';
            await fetch('/capture-lead', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email: userEmail }) });
            sendMessage();
        }
        async function downloadPDF() {
            const res = await fetch('/download-audit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ score: lastScore, verdict: lastVerdict }) });
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "ZaHouse_Audit.pdf"; a.click();
        }
    </script>
</body>
</html>
